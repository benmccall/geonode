{% extends "page_layout.html" %}
{% load i18n %}
{% load geonode_auth %}
{% load flag_tags %}
{% load thumbnail %}

{% block title %} {{ document.title }} - {{ block.super }} {% endblock %}

{% block head %}
    {% include "geonode/ext_header.html" %}
    {% include "geonode/app_header.html" %}
    {% include "geonode/geo_header.html" %}
    {{ block.super }}
    <script type="text/javascript">
        var app;
        Ext.onReady(function() {
            {% autoescape off %}

                {% has_obj_perm user document "documents.change_document_permissions" as can_change_permissions %}
                {% if can_change_permissions %}
                    new GeoNode.PermissionsEditor({
                        levels: {
                            'admin': 'document_admin',
                            'readwrite': 'document_readwrite',
                            'readonly': 'document_readonly',
                            'none': '_none'
                        },
                        renderTo: "permissions_form",
                        userLookup: "{% url geonode.views.ajax_lookup %}",
                        permissions: {{ permissions_json }},
                        listeners: {
                            updated: function(perms) {
                                var submitTo = "{% url documents.views.ajax_document_permissions document.id %}";
                                Ext.Ajax.request({ url: submitTo, jsonData: perms.writePermissions() });
                            }
                        }
                    });
                {% endif %}
            {% endautoescape %}
        });
    </script>
{% endblock %}

{% block main %}
    <div class="twocol">
        <h3>{{ document.title }}</h3>

		{% if document.type in imgtypes %}
        <div id="embedded_map">
			{% thumbnail document.file "600" crop="center" as im %}
				<a href="{{document.file.url}}" target="_blank"><img src="{{ im.url }}" width="600" height="{{ im.height }}" /></a>
			{% endthumbnail %}
        </div>
		{% elif document.type == "pdf" %}
			<iframe src="http://docs.google.com/gview?url=http://{{ request.get_host }}{{ document.file.url }}&embedded=true" style="width:100%; height:350px;" frameborder="0"></iframe>
			<br/>
			<p><a href="{{ document.file.url }}" target="_blank">Download the {{ document }} document</a></p>
		{% else %}
			<p><a href="{{ document.file.url }}" target="_blank">Download the {{ document }} document</a></p>
	    {%  endif %}
        <p><strong>{% trans "Contact:" %}</strong> <a
                href="{{ document.owner.get_profile.get_absolute_url }}">{{ document.owner }}</a></p>

		{% if request.user.is_authenticated %}
			{% if document|can_be_flagged_by:request.user and not request.user.is_staff %}
				<a href="{{ layer|flag_confirm_url:'owner' }}">Flag as Inappropriate</a>
			{% elif request.user.is_staff %}
				{% if document|flag_count == 0 %}
					<a href="{{ document|flag_confirm_url_with_status:'owner' }}">Flag as Inappropriate</a>
				{% else %}
					<a href="{{ document|flag_confirm_url_with_status:'owner' }}">Update Flag Status</a>
				{% endif %}
			{% endif %}
		{% endif %}

    </div>
{% endblock %}
{% block sidebar %}
    <div id="sidebar" class="threecol">
        <h3>{% trans "Maps" %}</h3>

        <p>{% trans "Maps related to this document" %}</p>
        <ul>
	        {% for map in document.maps.all %}
            <li><a href='/maps/{{map.id}}'>{{ map }}</a></li>
	        {% endfor %}
        </ul>

        {% has_obj_perm user document "documents.change_document_permissions" as can_change_permissions %}
        {% if can_change_permissions %}
            <h3>{% trans "Permissions" %}</h3>
            <p>{% trans "Select what kind of privileges to allow." %}</p>
            <div id="permissions_form"></div>
        {% endif %}
    </div>
{% endblock %}
